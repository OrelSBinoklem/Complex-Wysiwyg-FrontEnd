{"version":3,"sources":["js/main.js"],"names":["jQuery","$","next","openOptions","animations","openOptionsTimeLine__close","pause","css","display","opacity","transform","openOptionsTimeLine","restart","TimelineLite","append","TweenMax","to","addClass","closeOptions","handlerComplete","onComplete","removeClass","on","this","hasClass","e","target","closest","add","size","handlerAddPage","urn","console","log","refreshMenuView","dragItemList","$main","empty","res","recursion","el","html","i","name","type","_class","collapsed","sub","session","data","pages","find","nestedSortable","forcePlaceholderSize","handle","items","placeholder","revert","tabSize","toleranceElement","listType","helper","maxLevels","isTree","start","stop","update","event","ui","clearEmptyUl","refreshNestedEl","clearCollapseNotNested","pagesNestedToJson","savePages","refreshCollapsed","json","previousLevel","stack","0","each","level","parents","length","obj","push","itemToJson","$item","attr","parent","remove","not","pageManagerVisualizator","modules","$mapNavigatorContainer","nameIFrame","pixelsScrollableInSeconds","minWOuterScroll","minHOuterScroll","minWDraggable","minHDraggable","minWIFrame","minHIFrame","responsiveToMovementOfTheCursorInAConfinedSpace","gorizontalFixation","verticalFixation","mCustomScrollbar","axis","theme","scrollbarPosition","scrollInertia","mouseWheel","scrollAmount","callbacks","onUpdate","val","modal","_options","window","location","href","input","get","focus","stopPropagation","confirm","removePage","selectPage","first","reloadPage","$container","pmv.prepaste.iframe","width","height","pmv.load.iframe","setTimeout","_create","document","ready","shablonizator","updateBasesUrlPage","lastLoadPage","tooltip","popover","which","altKey","cancelBubble","preventDefault","socket","io","connect","once","sessionModel"],"mappings":"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","file":"main.js","sourcesContent":["/****************************************************/\r\n/*Шаблонизатор*/\r\n/****************************************************/\r\njQuery(function($) {\r\n    $(\"body\").on('keydown', function(e) {\r\n        if(e.which == 49 && e.altKey)//(e.which == 65 || e.which == 83 || e.which == 68)\r\n        {\r\n            e = e || window.e; if (e.stopPropagation) {e.stopPropagation()} else {e.cancelBubble = true} e.preventDefault();\r\n        }\r\n    });\r\n\r\n    var session;\r\n    var socket = io.connect('/');\r\n\r\n    socket.once('session.load', function (data) {\r\n        session = new modules.sessionModel(data, socket);\r\n        //console.log(data);\r\n        next();\r\n    });\r\n\r\n    function next() {\r\n        //Глобальные настройки\r\n        (function() {\r\n            var animations = {};\r\n            $( \".shab__global-settings-btn\" ).on(\"click\", function () {\r\n                if( !$(this).hasClass('active') ) {\r\n                    openOptions();\r\n                } else {\r\n                    closeOptions();\r\n                }\r\n            });\r\n\r\n            $( \"body\" ).on(\"click click.body.iframe\", function (e) {\r\n                if( $(e.target).closest($(\".shab__global-settings-btn\").add($(\".shab__global-settings\"))).size() == 0 ) {\r\n                    if( $(\".shab__global-settings-btn\").hasClass('active') ) {\r\n                        closeOptions();\r\n                    }\r\n                }\r\n            });\r\n\r\n            function openOptions() {\r\n                if( \"openOptionsTimeLine__close\" in animations ) { animations.openOptionsTimeLine__close.pause() }\r\n                $(\" .shab__global-settings\").css({\r\n                    display: \"block\",\r\n                    opacity: 0,\r\n                    transform: \"scale(0.8, 0.8)\"\r\n                });\r\n\r\n                if( !(\"openOptionsTimeLine\" in animations) ) {\r\n                    animations.openOptionsTimeLine = (new TimelineLite()).append([\r\n                        TweenMax.to($(\".shab__global-settings\"), 0.5,\r\n                            {css:{transform: \"scale(1, 1)\" }}),\r\n                        TweenMax.to($(\".shab__global-settings\"), 0.3,\r\n                            {css:{ opacity: 1 }})\r\n                    ]);\r\n                } else {\r\n                    animations.openOptionsTimeLine.restart();\r\n                }\r\n\r\n                $( \".shab__global-settings-btn\" ).addClass('active');\r\n            }\r\n\r\n            function closeOptions() {\r\n                if( \"openOptionsTimeLine\" in animations ) { animations.openOptionsTimeLine.pause() }\r\n                if( !(\"openOptionsTimeLine__close\" in animations) ) {\r\n                    animations.openOptionsTimeLine__close = (new TimelineLite()).append([\r\n                        TweenMax.to($(\".shab__global-settings\"), 0.5,\r\n                            {css:{ transform: \"scale(0.8, 0.8)\"}, onComplete: handlerComplete}),\r\n                        TweenMax.to($(\".shab__global-settings\"), 0.5,\r\n                            {css:{ opacity: 0 }})\r\n                    ]);\r\n                } else {\r\n                    animations.openOptionsTimeLine__close.restart();\r\n                }\r\n                function handlerComplete() {\r\n                    $(\".shab__global-settings\").css('display', 'none');\r\n                }\r\n\r\n                $( \".shab__global-settings-btn\" ).removeClass('active');\r\n            }\r\n\r\n            //$('#text-encoding-server').selectpicker();\r\n\r\n            //Кодировка на хосте\r\n            //$('#text-encoding-server').selectpicker('val', shablonizator.settings.find('text_encoding_server').text());\r\n\r\n            /*$('#text-encoding-server').on('change', function(){\r\n                shablonizator.textEncodingServer = $(this).val();\r\n                shablonizator.settings.find('text_encoding_server').text($(this).val());\r\n                shablonizator.save_g_settings();\r\n            });*/\r\n        })();\r\n\r\n        /****************************************************/\r\n        /*Менеджер страниц и визуализатор*/\r\n        /****************************************************/\r\n        (function() {\r\n            pageManagerVisualizator = new modules.pageManagerVisualizator($(\"#wrap_iframe\"), session, {\r\n                $mapNavigatorContainer: $('.shab__main-menu-container'),\r\n                nameIFrame: \"PP_iframe\",\r\n                pixelsScrollableInSeconds: 2000,\r\n                minWOuterScroll: 23,\r\n                minHOuterScroll: 23,\r\n                minWDraggable: 15,\r\n                minHDraggable: 15,\r\n                minWIFrame: 320,\r\n                minHIFrame: 480,\r\n                responsiveToMovementOfTheCursorInAConfinedSpace: false,\r\n                gorizontalFixation: \"center\",\r\n                verticalFixation: \"top\"\r\n            });\r\n\r\n            //Скроллбар для списка страниц\r\n            $(\".pmv__pages-sortable-scrollwrap\").mCustomScrollbar({\r\n                axis: \"y\",\r\n                theme: \"dark\",\r\n                scrollbarPosition: \"outside\",\r\n                scrollInertia: 100,\r\n                mouseWheel: {\r\n                    scrollAmount: 100\r\n                },\r\n                callbacks: {\r\n                    onUpdate: function() {\r\n                        if($(\".pmv__pages-sortable-scrollwrap\").hasClass(\"_mCS_1 mCS_no_scrollbar\")) {\r\n                            $(\".pmv__pages-window\").addClass(\"no-scrollbar\");\r\n                        } else {\r\n                            $(\".pmv__pages-window\").removeClass(\"no-scrollbar\");\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            $(\".pmv__select-page-open-list\").on(\"click\", function () {\r\n                if( !$(this).hasClass('active') ) {\r\n                    $(this).addClass('active');\r\n                } else {\r\n                    $(this).removeClass('active');\r\n                }\r\n            });\r\n            var dragItemList = false;\r\n            $(\"body\").on(\"click click.body.iframe\", function (e) {\r\n                if( $(e.target).closest($(\".pmv__select-page-open-list\").add($(\".pmv__pages-window\")).add($(\"#modal-pmv-add-page-href\"))).length == 0 && !dragItemList ) {\r\n                    if( $(\".pmv__select-page-open-list\").hasClass('active') ) {\r\n                        $(\".pmv__select-page-open-list\").removeClass('active');\r\n                    }\r\n                }\r\n            });\r\n\r\n            //Добавляем страницу\r\n            $('#modal-pmv-add-page-href .btn-select').on('click', function(event){\r\n                handlerAddPage( $('#modal-pmv-add-page-href .pmv-href').val() );\r\n                $('#modal-pmv-add-page-href .modal').modal('hide');\r\n            });\r\n            $('.pmv__add-page').on('click', function(){\r\n                if(pageManagerVisualizator._options.nameIFrame in window) {\r\n                    //отделить домен от urn\r\n                    $('#modal-pmv-add-page-href .pmv-href').val( window[pageManagerVisualizator._options.nameIFrame].window.location.href );\r\n                }\r\n                $('#modal-pmv-add-page-href .modal').modal('show');\r\n            });\r\n            $('#modal-pmv-add-page-href').on('shown.bs.modal', function(e){\r\n                var input = $('#modal-pmv-add-page-href .pmv-href');\r\n                //Выделение\r\n                input.get(0).focus();\r\n                //input.get(0).setSelectionRange(0, input.val().length);\r\n            });\r\n            function handlerAddPage(urn){\r\n                //pageManagerVisualizator.addPage( href );\r\n                console.log(urn);\r\n            }\r\n\r\n            //Удаляем страницу\r\n            $('.shab__top-menu .select-page.selectpicker').on('selectpicker.refresh', function(){//Чтоб при клике на крестике не переключалась страница\r\n                $('.shab__top-menu .select-page .delete').on('click', function(e){\r\n                    e.stopPropagation();\r\n                    if( confirm( \"Точно удалить!\" ) ) {\r\n                        pageManagerVisualizator.removePage( $(this).attr('data-href') );\r\n                    }\r\n                    return false;\r\n                });\r\n            });\r\n\r\n            //Сменяем страницу\r\n            $('.shab__top-menu').on('change', ' .select-page.selectpicker', function() {\r\n                pageManagerVisualizator.selectPage( $('.shab__top-menu .select-page option:selected').first().attr('data-href') );\r\n            });\r\n\r\n            //Обновляем страницу\r\n            $('.pmv__update-iframe-btn').on('click', pageManagerVisualizator.reloadPage);\r\n\r\n            //Обновляем список страниц в верхнем меню\r\n            pageManagerVisualizator.$container.on(\"pmv.change.pagelist\", refreshMenuView);\r\n            refreshMenuView();\r\n            \r\n            function refreshMenuView() {\r\n                dragItemList = false;\r\n                var $main = $(\".pmv__pages-sortable\");\r\n                $main.empty();\r\n                //session\r\n                var res = (function recursion(el, html) {\r\n                    html += \"<ul>\";\r\n\r\n                    //li\r\n                    for(var i in el) {\r\n                        var name = (el[i].type == \"page\") ? el[i].urn : el[i].name;\r\n                        var _class = (el[i].type == \"page\")?\"page\":\"group\";\r\n                        html += \"<li class='pmv__pages-item \"+((\"collapsed\" in el[i] && el[i].collapsed)?\"collapsed\":\"\")+\"' data-type='\"+(el[i].type)+\"' data-name='\"+name+\"'>\";\r\n                        html += '<div class=\"pmv__pages-item-content\">' +\r\n                            '<button class=\"btn btn-default btn-xs pmv__pages-btn-collapsed\"><span class=\"glyphicon glyphicon-minus\"></span><span class=\"glyphicon glyphicon-plus\"></span></button>' +\r\n                            '<button class=\"btn btn-default btn-xs btn-block pmv__pages-btn-'+_class+'\">'+name+'</button>' +\r\n                            '<div class=\"btn btn-default btn-xs pmv__pages-btn-drag\"><span class=\"glyphicon glyphicon-move\"></span></div>' +\r\n                            '</div>';\r\n\r\n                        //sub\r\n                        if(\"sub\" in el[i]) {\r\n                            html = recursion(el[i].sub, html);\r\n                        }\r\n                        //sub (end)\r\n\r\n                        html += \"</li>\";\r\n\r\n                    }\r\n                    //li (end)\r\n\r\n                    return html += \"</ul>\";\r\n                })(session.data.pages, \"\", 0);\r\n\r\n                $main.append(res);\r\n                $main.find(\" > ul\").nestedSortable({\r\n                    forcePlaceholderSize: true,\r\n                    handle: 'div',\r\n                    items: 'li',\r\n                    placeholder: 'placeholder',\r\n                    revert: 250,\r\n                    tabSize: 25,\r\n                    toleranceElement: '> div',\r\n                    listType: \"ul\",\r\n                    helper:\t'clone',\r\n                    maxLevels: 3,\r\n                    isTree: true,\r\n                    start: function () {\r\n                        dragItemList = true;\r\n                    },\r\n                    stop: function () {\r\n                        dragItemList = false;\r\n                    },\r\n                    update: function( event, ui ) {\r\n                        clearEmptyUl($main);\r\n                        refreshNestedEl($main);\r\n                        clearCollapseNotNested($main);\r\n                        session.data.pages = pagesNestedToJson($main);\r\n                        session.savePages();\r\n                    }\r\n                });\r\n                refreshNestedEl($main);\r\n                refreshCollapsed($main);\r\n            }\r\n\r\n            $(\".pmv__pages-sortable\").on(\"click\", \" .pmv__pages-btn-collapsed\", function(){\r\n                var $item = $(this).closest(\".pmv__pages-item\");\r\n                if( $item.hasClass(\"collapsed\") ) {\r\n                    $item.removeClass(\"collapsed\")\r\n                        .find(\" > ul\").css({display: \"block\"});\r\n                } else {\r\n                    $item.addClass(\"collapsed\")\r\n                        .find(\" > ul\").css({display: \"none\"});\r\n                }\r\n            });\r\n\r\n            //Парсинг страниц в json обьект\r\n            function pagesNestedToJson($main) {\r\n                var json = [], previousLevel = 0, stack = {\"0\":json};\r\n\r\n                $main.find(\".pmv__pages-item\").each(function() {\r\n                    var level = $(this).parents(\".pmv__pages-item\").length;\r\n                    if(level > previousLevel) {\r\n                        var obj = stack[previousLevel][stack[previousLevel].length-1];\r\n                        if(!(\"sub\" in obj)) {\r\n                            obj.sub = [];\r\n                            stack[level] = obj.sub;\r\n                        }\r\n                        stack[level].push(itemToJson($(this)));\r\n                    } else {\r\n                        stack[level].push(itemToJson($(this)));\r\n                    }\r\n                    previousLevel = level;\r\n                });\r\n\r\n                return json;\r\n            }\r\n\r\n                function itemToJson($item) {\r\n                    var obj = {};\r\n                    obj.type = $item.attr(\"data-type\");\r\n\r\n                    if($item.attr(\"data-type\") == \"page\") {\r\n                        obj.urn = $item.attr(\"data-name\");\r\n                    } else {\r\n                        obj.name = $item.attr(\"data-name\");\r\n                    }\r\n\r\n                    if($item.hasClass(\"collapsed\")) {\r\n                        obj.collapsed = true;\r\n                    }\r\n                    return obj;\r\n                }\r\n\r\n            //удаляем пустые тэги ul которые остаються после перестановки\r\n            function clearEmptyUl($main) {\r\n                $main.find(\" ul\").addClass(\"not-childrens\");\r\n                $main.find(\" ul > li\").each(function() {\r\n                    $(this).parent().removeClass(\"not-childrens\");\r\n                });\r\n                console.log($main.find(\" ul.not-childrens\").length);\r\n                $main.find(\" ul.not-childrens\").remove();\r\n            }\r\n\r\n            //очитстить от коллапсов\r\n            function clearCollapseNotNested($main) {\r\n                $main.find(\" .pmv__pages-item\").each(function() {\r\n                    if(!$(this).hasClass(\"have-nested\")) {\r\n                        $(this).removeClass(\"collapsed\");\r\n                    }\r\n                });\r\n            }\r\n\r\n            function refreshNestedEl($main) {\r\n                //Вставляем класс для вложенных\r\n                $main.find(\" .pmv__pages-item\").removeClass(\"have-nested\");\r\n                $main.find(\" ul\").each(function() {\r\n                    if($(this).parent(\".pmv__pages-item\").length) {\r\n                        $(this).parent(\".pmv__pages-item\").addClass(\"have-nested\");\r\n                    }\r\n                });\r\n            }\r\n            \r\n            function refreshCollapsed($main) {\r\n                //Коллапсируем рассколапсируем\r\n                $main.find(\" .pmv__pages-item.collapsed > ul\").css({display: \"none\"});\r\n                $main.find(\" .pmv__pages-item > ul\").not($main.find(\" .pmv__pages-item.collapsed > ul\")).css({display: \"block\"});\r\n            }\r\n\r\n            //При загрузке iFrame скрываем всё окно шаблонизатора и показываем анимацию загрузки\r\n            pageManagerVisualizator.$container.on({\r\n                \"pmv.prepaste.iframe\": function() {\r\n                    $( \"#loading\" )\r\n                        .css({width: \"100%\", height: \"100%\"})\r\n                        .addClass( \"show\" );\r\n                },\r\n                \"pmv.load.iframe\": function() {\r\n                    $( \"#loading\" ).removeClass( \"show\" );\r\n                    setTimeout(function() {\r\n                        $( \"#loading\" ).css({width: \"0\", height: \"0\"});\r\n                    }, 500);\r\n                }\r\n            });\r\n\r\n            pageManagerVisualizator._create();\r\n        })();\r\n\r\n        /****************************************************/\r\n        /*Пиксель перфект*/\r\n        /****************************************************/\r\n        /*(function() {\r\n            pixelPerfect = new modules.pixelPerfect($(\"#wrap_iframe .pmv-fitting-wrap\"), {\r\n                urlXML: \"sb/pixel-perfect.xml\",\r\n                dirScrins: \"design\",\r\n                dirThumbnail: \"sb/design-thumbnails\",\r\n                widthThumbnail: 240,\r\n                nameIFrame: \"PP_iframe\",\r\n                $screenshotsManipulatorContainer: $('.shab-general-window__bottom'),\r\n                thumbnailScrollAmount: 100,\r\n                mainWindowScrollAmount: 100\r\n            });\r\n\r\n            pageManagerVisualizator.$container.on( \"pmv.load.iframe\", function(){\r\n                pixelPerfect._destroy();\r\n                pixelPerfect._create( pageManagerVisualizator.lastLoadPage );\r\n\r\n                if( \"$session\" in pixelPerfect ) {\r\n                    pixelPerfect.screenshotsManipulator.refresh( pixelPerfect.$session, pixelPerfect.$listAllScrins, pixelPerfect.currentPage );\r\n                    handlerRefreshSelectSize();\r\n                }\r\n            });\r\n\r\n            //Добавляем разрешение\r\n            $('#modal-pp-add-group .btn-select').on('click', function(event){\r\n                var hasError = false;\r\n\r\n                //Фильтрация ввода\r\n                if( !( /^[1-9]\\d{1,3}$/gim.test( $('#modal-pp-add-group .pp-width').val() ) ) ) {\r\n                    hasError = true;\r\n                    $('#modal-pp-add-group .pp-width').closest( \".input-group\" ).addClass( \"has-error\" );\r\n                } else {\r\n                    $('#modal-pp-add-group .pp-width').closest( \".input-group\" ).removeClass( \"has-error\" );\r\n                }\r\n                if( !(/^[1-9]\\d{1,3}$/gim.test( $('#modal-pp-add-group .pp-height').val() ) ) ) {\r\n                    hasError = true;\r\n                    $('#modal-pp-add-group .pp-height').closest( \".input-group\" ).addClass( \"has-error\" );\r\n                } else {\r\n                    $('#modal-pp-add-group .pp-height').closest( \".input-group\" ).removeClass( \"has-error\" );\r\n                }\r\n\r\n                if( hasError ) {\r\n                    $('#modal-pp-add-group .alert-input-error').css({display: \"block\"});\r\n                } else {\r\n                    $('#modal-pp-add-group .alert-input-error').css({display: \"none\"});\r\n                }\r\n\r\n                if( !hasError ) {\r\n                    pixelPerfect.addSize( $('#modal-pp-add-group .pp-width').val(), $('#modal-pp-add-group .pp-height').val() );\r\n                    $('#modal-pp-add-group .modal').modal('hide');\r\n                }\r\n            });\r\n            $('.shab__top-menu .add-group').on('click', function(){\r\n                $('#modal-pp-add-group .modal').modal('show');\r\n            });\r\n\r\n            //Удаляем разрешение\r\n            $('.shab__top-menu .select-group.selectpicker').on('selectpicker.refresh', function(){//Чтоб при клике на крестике не переключалась страница\r\n                $('.shab__top-menu .select-group .delete').on('click', function(e){\r\n                    e.stopPropagation();\r\n                    if( confirm( \"Точно удалить!\" ) ) {\r\n                        pixelPerfect.removeSize( $(this).attr( \"data-width\" ), $(this).attr( \"data-height\" ) );\r\n                    }\r\n                    return false;\r\n                });\r\n            });\r\n\r\n            //Сменяем разрешение\r\n            $('.shab__top-menu').on('change', ' .select-group', function() {\r\n                var $optionSelected = $('.shab__top-menu .select-group option:selected');\r\n                pixelPerfect.selectSize( $optionSelected.attr('data-width'), $optionSelected.attr('data-height') );\r\n            });\r\n\r\n            //Обновляем список разрешений в верхнем меню\r\n            $('.shab__top-menu .select-group.selectpicker').selectpicker();\r\n            pixelPerfect.$container.on(\"pp.change.sizelist pp.create.sizelist\", function(){\r\n                handlerRefreshSelectSize();\r\n            });\r\n            pixelPerfect.screenshotsManipulator.$container.on(\"sm.change_post_set_session\", function(){\r\n                handlerRefreshSelectSize();\r\n            });\r\n            function handlerRefreshSelectSize() {\r\n                var pageList = pageManagerVisualizator._options.pageList;\r\n                var $selectSize = $('.shab__top-menu .select-group.selectpicker');\r\n                $selectSize.empty();\r\n                pixelPerfect.$session.find( \"page[href='\"+( pageManagerVisualizator.lastLoadPage )+\"'] media[width][height]\" ).each(function(){\r\n                    if( $(this).attr( \"active\" ) == \"true\" ) {\r\n                        $selectSize.append('<option selected=\"selected\" data-width=\"'+( $(this).attr( \"width\" ) )+'\" data-height=\"'+( $(this).attr( \"height\" ) )+'\" data-content=\"<span data-width=\\''+( $(this).attr( \"width\" ) )+'\\' data-height=\\''+( $(this).attr( \"height\" ) )+'\\' class=\\'delete glyphicon glyphicon-remove\\'></span>&nbsp;&nbsp;<span>'+( $(this).attr( \"width\" ) + \"x\" + $(this).attr( \"height\" ) )+'</span>\"></option>');\r\n                    } else {\r\n                        $selectSize.append('<option data-width=\"'+( $(this).attr( \"width\" ) )+'\" data-height=\"'+( $(this).attr( \"height\" ) )+'\" data-content=\"<span data-width=\\''+( $(this).attr( \"width\" ) )+'\\' data-height=\\''+( $(this).attr( \"height\" ) )+'\\' class=\\'delete glyphicon glyphicon-remove\\'></span>&nbsp;&nbsp;<span>'+( $(this).attr( \"width\" ) + \"x\" + $(this).attr( \"height\" ) )+'</span>\"></option>');\r\n                    }\r\n                });\r\n                $selectSize.selectpicker( \"refresh\" );\r\n                $selectSize.trigger( \"selectpicker.refresh\" );\r\n            }\r\n            //Показать \"манипулятор скриншотов\"\r\n            $('.pp__open-btn').on('click', function(){\r\n                pixelPerfect.screenshotsManipulator.toggle( pixelPerfect.$session );\r\n            });\r\n\r\n            //Обновить кнопку\r\n            pixelPerfect.screenshotsManipulator.$container.on({\r\n                \"sm.show\": function(){\r\n                    $('.pp__open-btn').addClass( \"active\" );\r\n                },\r\n                \"sm.hide\": function(){\r\n                    $('.pp__open-btn').removeClass( \"active\" );\r\n                }\r\n            });\r\n\r\n            //Показать верстку или скрины или 50 на 50\r\n            $('.pp__verstka-btn').on('click', function(){\r\n                pixelPerfect.showPageProofsOrDesign(0);\r\n            });\r\n            $('.pp__50p-btn').on('click', function(){\r\n                pixelPerfect.showPageProofsOrDesign(1);\r\n            });\r\n            $('.pp__design-btn').on('click', function(){\r\n                pixelPerfect.showPageProofsOrDesign(2);\r\n            });\r\n\r\n            //Горячие клавишы\r\n            pageManagerVisualizator.$container.on( \"pmv.load.iframe\", function(){\r\n                $('body')\r\n                    .add( $('#'+(pageManagerVisualizator._options.nameIFrame)).contents().find(\"body\") )\r\n                    .on('keydown', function(e) {\r\n                        if(e.which == 81 && e.ctrlKey && !e.shiftKey && !e.altKey)//(e.which == 65 || e.which == 83 || e.which == 68)\r\n                        {\r\n                            if($('.pp__50p-btn, .pp__design-btn').hasClass('active'))\r\n                            {\r\n                                pixelPerfect.showPageProofsOrDesign(0);\r\n                            }\r\n                            else\r\n                            {\r\n                                pixelPerfect.showPageProofsOrDesign(1);\r\n                            }\r\n\r\n                            e = e || window.e; if (e.stopPropagation) {e.stopPropagation()} else {e.cancelBubble = true} e.preventDefault();\r\n                        }\r\n                    });\r\n            });\r\n\r\n            //Обновить кнопки\r\n            pixelPerfect.$container.on(\"pp.changepageproofsordesign\", function(e, show){\r\n                $('.pp-verstka-design .btn').removeClass( \"active btn-primary btn-success btn-info btn-warning btn-danger\" ).addClass( \"btn-default\" );\r\n                switch( show ){\r\n                    case 0:\r\n                        $('.pp__verstka-btn').removeClass( \"btn-default\" ).addClass( \"active btn-primary\" );\r\n                        break;\r\n                    case 1:\r\n                        $('.pp__50p-btn').removeClass( \"btn-default\" ).addClass( \"active btn-warning\" );\r\n                        break;\r\n                    case 2:\r\n                        $('.pp__design-btn').removeClass( \"btn-default\" ).addClass( \"active btn-danger\" );\r\n                        break;\r\n                }\r\n            });\r\n        })();*/\r\n\r\n        /****************************************************/\r\n        /*Для тестов*/\r\n        /****************************************************/\r\n        $(document).ready(function(){\r\n            $('#testovaya_ssilka').on('click', function(event){\r\n\r\n            });\r\n        });\r\n\r\n        /****************************************************/\r\n        /*Вспомогательная хрень*/\r\n        /****************************************************/\r\n        $(document).ready(function(){\r\n            pageManagerVisualizator.$container.on( \"pmv.load.iframe\", function(){\r\n                shablonizator.updateBasesUrlPage( pageManagerVisualizator.lastLoadPage );\r\n            });\r\n\r\n            //Подсказки\r\n            $('[data-toggle=\"tooltip\"]').tooltip();\r\n            $('[data-toggle=\"popover\"]').popover();\r\n            //==========\r\n        });\r\n    }\r\n});\r\n\r\n"]}