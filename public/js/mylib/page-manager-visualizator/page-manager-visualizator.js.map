{"version":3,"sources":["js/mylib/page-manager-visualizator/page-manager-visualizator.js"],"names":["$","pageManagerVisualizator","$container","sessionModel","options","this","_options","____","customScrollIFrame","modules","mapNavigatorIFrame","resizeIFrame","fixationContentAtResize","_initPasteHTML","on","reload","pmv.load.iframe","rif.center-iframe","updateDraggable","rifStartResize","startFixation","rifStopResize","stopFixation","setSizeIFrame","w","source_h","fast","h","$fittingWrap","closest","parseInt","Math","round","heightCalculateRatio","minHeightCalculateAuto","calculatedHeightAsMaxHeight","stop","css","width","height","maxHeight","$outerWrap","animate","setPositionIFrame","l_factor","t_factor","w_c","h_c","l","t","$iframe","top","left","_centerIFrameAndNoEmptySpace","setScrollIFrame","wWindow","wDocument","leftScroll","hWindow","hDocument","topScroll","iframe","window","nameIFrame","document","scrollLeft","scrollTop","_create","_init","_handlerMouseWheel","_destroy","off","find","remove","append","localSession","getLocalSessionParams","pageList","selectPage","href","currentPage","_destroyIFrame","_createIFrame","trigger","lastLoadPage","load","contents","e","_saveSession","jQuery"],"mappings":"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","file":"page-manager-visualizator.js","sourcesContent":["(function($){//Модули: getfile, setfile, .xml(), customScrollIFrame\r\n\r\nvar defaultOptions = {\r\n    $mapNavigatorContainer: undefined,\r\n    nameIFrame: \"PP_iframe\",\r\n    pixelsScrollableInSeconds: 2000,\r\n    minWOuterScroll: 23,\r\n    minHOuterScroll: 23,\r\n    minWDraggable: 15,\r\n    minHDraggable: 15,\r\n    minWIFrame: 320,\r\n    minHIFrame: 480,\r\n    responsiveToMovementOfTheCursorInAConfinedSpace: true,\r\n    movementOfTheCursorInAConfinedSpaceSpred: 10,\r\n    \r\n    gorizontalFixation: \"center\",\r\n    verticalFixation: \"top\",\r\n\r\n    minHeightCalculateAuto: 480,\r\n    heightCalculateRatio: 16/9,\r\n    calculatedHeightAsMaxHeight: true,\r\n    stopAllAnimationsAtResize: true\r\n};\r\n\r\nvar pageManagerVisualizator = function($container, sessionModel, options) {\r\n    this._options = options;\r\n    var ____ = this;\r\n    ____.$container = $container;\r\n    \r\n    var customScrollIFrame = new modules.customScrollIFrame($container, this._options);\r\n    var mapNavigatorIFrame = new modules.mapNavigatorIFrame($container, this._options);\r\n    var resizeIFrame = new modules.resizeIFrame($container, this._options);\r\n    var fixationContentAtResize = new modules.fixationContentAtResize($container, this._options);\r\n    \r\n    //Синхронизируем с кастомным скроллом\r\n    customScrollIFrame._initPasteHTML();\r\n    $container.on(\"pmv.load.iframe\", function(){\r\n        customScrollIFrame.reload();\r\n    });\r\n    //Синхронизируем с мап навигатором\r\n    $container.on({\r\n        \"pmv.load.iframe\": mapNavigatorIFrame.reload,\r\n        \"rif.center-iframe\": mapNavigatorIFrame.updateDraggable\r\n    });\r\n    //Синхронизируем с ресайзером\r\n    $container.on(\"pmv.load.iframe\", resizeIFrame.reload);\r\n    //Синхронизируем с фиксатором контента при ресайзе\r\n    $container.on({\r\n        \"pmv.load.iframe\": fixationContentAtResize.reload,\r\n        \"rifStartResize\": fixationContentAtResize.startFixation,\r\n        \"rifStopResize\": fixationContentAtResize.stopFixation\r\n    });\r\n\r\n    this.setSizeIFrame = function( w, source_h, fast ) {\r\n        var $fittingWrap = $(\"#\"+(____._options.nameIFrame)).closest(\".pmv-fitting-wrap\");\r\n\r\n        var h;\r\n\r\n        w = parseInt(w);\r\n\r\n        if(source_h == \"auto\") {\r\n            h = Math.round(w / ____._options.heightCalculateRatio);\r\n            if(h < ____._options.minHeightCalculateAuto) {\r\n                h = ____._options.minHeightCalculateAuto;\r\n            }\r\n        } else {\r\n            h = source_h;\r\n        }\r\n\r\n        if(fast) {\r\n            fixationContentAtResize.startFixation();\r\n\r\n            if(source_h == \"auto\" && ____._options.calculatedHeightAsMaxHeight) {\r\n                $fittingWrap.stop().css({width: w+'px', height: '100%', maxHeight: h+'px'});\r\n            } else {\r\n                $fittingWrap.stop().css({width: w+'px', height: h+'px', maxHeight: ''});\r\n            }\r\n\r\n            fixationContentAtResize.stopFixation();\r\n        } else {\r\n            fixationContentAtResize.startFixation();\r\n\r\n            if(source_h == \"auto\" && ____._options.calculatedHeightAsMaxHeight) {\r\n                var $outerWrap = $(\"#\"+(____._options.nameIFrame)).closest(\".pmv-outer-wrap\");\r\n\r\n                $fittingWrap.css({height: ($fittingWrap.height())+'px', maxHeight: ''});\r\n                \r\n                $fittingWrap.stop().animate({width: w+'px', height: ((h < $outerWrap.height())?h:$outerWrap.height())+'px'}, 1000, \"swing\", function() {\r\n                    $fittingWrap.stop().css({width: w+'px', height: '100%', maxHeight: h+'px'});\r\n\r\n                    fixationContentAtResize.stopFixation();\r\n                });\r\n            } else {\r\n                $fittingWrap.css({maxHeight: ''});\r\n                $fittingWrap.stop().animate({width: w+'px', height: h+'px'}, 1000, \"swing\", function() {\r\n                    fixationContentAtResize.stopFixation();\r\n                });\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n    this.setPositionIFrame = function(l_factor, t_factor) {\r\n        var $iframe = $(\"#\" + (____._options.nameIFrame));\r\n        var $fittingWrap = $iframe.closest(\".pmv-fitting-wrap\");\r\n        var $outerWrap = $iframe.closest(\".pmv-outer-wrap\");\r\n        var w, h, w_c, h_c, l, t;\r\n\r\n        w = $fittingWrap.width();\r\n        h = $fittingWrap.height();\r\n        w_c = $outerWrap.width();\r\n        h_c = $outerWrap.height();\r\n\r\n        l = Math.round( (w_c - w) * l_factor );\r\n        t = Math.round( (h_c - h) * t_factor );\r\n\r\n        $fittingWrap.css({\r\n            top: t,\r\n            left: l\r\n        });\r\n\r\n        resizeIFrame._centerIFrameAndNoEmptySpace();//И так сработает после всех методов - потому что события выполняються позже (КРОМЕ FIREFOX)\r\n    }\r\n\r\n    this.setScrollIFrame = function(l_factor, t_factor) {\r\n        var iframe = window[____._options.nameIFrame];\r\n        var wWindow, wDocument, leftScroll, hWindow, hDocument, topScroll;\r\n\r\n        wWindow = $(iframe.window).width();\r\n        wDocument = $(iframe.document).width();\r\n        hWindow = $(iframe.window).height();\r\n        hDocument = $(iframe.document).height();\r\n\r\n        leftScroll = Math.round( (wDocument - wWindow) * l_factor );\r\n        topScroll = Math.round( (hDocument - hWindow) * t_factor );\r\n\r\n        $(iframe.window).scrollLeft((leftScroll < 0)?0:leftScroll);\r\n        $(iframe.window).scrollTop((topScroll < 0)?0:topScroll);\r\n    }\r\n\r\n    this._create = function() {\r\n        this._init();\r\n        \r\n        //Чтобы скролл работал не только в iFrame Но и во всём блоке\r\n        $container.on('wheel', customScrollIFrame._handlerMouseWheel);\r\n    }\r\n    \r\n    this._destroy = function() {\r\n        //Чтобы скролл работал не только в iFrame Но и во всём блоке\r\n        $container.off('wheel', customScrollIFrame._handlerMouseWheel);\r\n        \r\n        $container.find( \".pmv-outer-wrap\" ).remove();\r\n    }\r\n    \r\n    this._init = function() {\r\n        $container.append('<div class=\"pmv-outer-wrap\"><div class=\"pmv-fitting-wrap\"></div></div>');\r\n        $container.append('<div class=\"pmv-container-bl\"></div><div class=\"pmv-container-bb\"></div><div class=\"pmv-container-br\"></div>');\r\n        //Получем список страниц\r\n        ____.localSession = sessionModel.getLocalSessionParams();\r\n        options.pageList = {};\r\n    }\r\n    \r\n    this.selectPage = function(href) {\r\n        ____.currentPage = href;\r\n        ____._destroyIFrame();\r\n        if(href !== null) {\r\n            ____._createIFrame(href);\r\n        }\r\n    }\r\n    \r\n    this._createIFrame = function(href) {\r\n        $container.trigger(\"pmv.prepaste.iframe\");\r\n        ____.lastLoadPage = href;\r\n        ____.currentPage = href;\r\n        $container.find( \".pmv-fitting-wrap\" ).append('<iframe id=\"'+(____._options.nameIFrame)+'\" name=\"'+(____._options.nameIFrame)+'\" src=\"'+href+'\" width=\"100%\" height=\"100%\"></iframe>');\r\n        $('#'+(____._options.nameIFrame)).load(function(){\r\n            $container.trigger( \"pmv.load.iframe\");\r\n            $('#'+(____._options.nameIFrame)).contents().find('body').on('click', function(e){\r\n                $(\"body\").trigger( \"click.body.iframe\" );\r\n            });\r\n        });\r\n    }\r\n    \r\n    this._destroyIFrame = function() {\r\n        $( '#'+(____._options.nameIFrame) ).remove();\r\n    }\r\n    \r\n    this._saveSession = function() {\r\n        /*if( \"$session\" in ____ ) {\r\n            //Сохраняем страницы (синхронизируем pageList и xml)\r\n                var $pages = ____.$session.find( \" pages\" );\r\n                var pre_href;\r\n                //вставляем которых нет в xml\r\n                for(var href in ____._options.pageList) {\r\n                    var page = ____._options.pageList[href];\r\n                    \r\n                    var $page = $pages.find( \"page[href='\"+(href)+\"']\" );\r\n                    if( $page.size() ) {\r\n                        $page.attr( \"active\", page.active );\r\n                    } else {\r\n                        if( pre_href ) {\r\n                            var $page = $pages.find( \"page[href='\"+(pre_href)+\"']\" );\r\n                            $page.after( '<page href=\"'+(href)+'\" active=\"'+(page.active)+'\" />' );\r\n                        } else {\r\n                            $pages.append( '<page href=\"'+(href)+'\" active=\"'+(page.active)+'\" />' );\r\n                        }\r\n                    }\r\n                    pre_href = href;\r\n                }\r\n                //удаляем которых нет в pageList\r\n                $pages.find( \" page\" ).each(function(){\r\n                    if( !($(this).attr( \"href\" ) in ____._options.pageList) ) {\r\n                        $(this).remove();\r\n                    }\r\n                });\r\n            \r\n            //Сохраняем состояние iFrame (если он есть)\r\n            if( ____._options.nameIFrame in window ) {\r\n                var $thisPage = ____.$session.find( \"pages page[href='\"+(____.lastLoadPage)+\"']\" );\r\n                if( $thisPage.size() ) {\r\n                    var iframe = window[____._options.nameIFrame];\r\n                    var $iframe = $(\"#\"+(____._options.nameIFrame));\r\n                    var $fittingWrap = $iframe.closest(\".pmv-fitting-wrap\");\r\n                    \r\n                    $thisPage\r\n                        .attr( \"scrolltop\", Math.round( $(iframe.window).scrollTop() || 0) )\r\n                        .attr( \"scrollleft\",  Math.round( $(iframe.window).scrollLeft() || 0) )\r\n                        .attr( \"l\", Math.round( $fittingWrap.position().left) )\r\n                        .attr( \"t\", Math.round( $fittingWrap.position().top) )\r\n                        .attr( \"w\", Math.round( $fittingWrap.width()) )\r\n                        .attr( \"h\", Math.round( $fittingWrap.height()) );\r\n                }\r\n            }\r\n            \r\n            //'<\\?xml version=\"1.0\" encoding=\"UTF-8\"\\?>'+\r\n            var resxml = ____.$session.xml().join('');\r\n            \r\n            //Записываем в файл\r\n            $.ajax({\r\n                url: \"sb.php\",\r\n                async: true,\r\n                cache: false,\r\n                type: \"POST\",\r\n                data: ({module: 'setfile', dir: ____._options.urlXML, file_text: resxml, text_encoding: 'UTF-8'})\r\n            });\r\n        }*/\r\n    }\r\n}\r\n\r\n    modules.pageManagerVisualizator = pageManagerVisualizator;\r\n    \r\n})(jQuery);"]}