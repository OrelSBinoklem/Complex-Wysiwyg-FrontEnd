{"version":3,"sources":["js/mylib/page-manager-visualizator/page-manager-visualizator.js"],"names":["$","pageManagerVisualizator","$container","sessionModel","options","this","_options","____","customScrollIFrame","modules","mapNavigatorIFrame","$mapNavigatorContainer","resizeIFrame","fixationContentAtResize","_initPasteHTML","on","reload","pmv.load.iframe","rif.start.resize","startFixation","rif.stop.resize","stopFixation","_create","_init","_handlerMouseWheel","_destroy","off","_saveSession","find","remove","append","pageList","_restoreSession","_centerIFrameAndNoEmptySpace","selectPage","href","currentPage","_destroyIFrame","_createIFrame","trigger","lastLoadPage","load","contents","e","specific","$session","each","attr","active","key","scrollTop","scrollLeft","iframe","window","nameIFrame","$page","size","parseInt","t","l","$iframe","$fittingWrap","closest","css","left","top","w","h","width","height","pre_href","$pages","page","after","$thisPage","Math","round","position","resxml","xml","join","ajax","url","async","cache","type","data","module","dir","urlXML","file_text","text_encoding","_restoreSessionFromSubModules","jQuery"],"mappings":"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","file":"page-manager-visualizator.js","sourcesContent":["(function($){//Модули: getfile, setfile, .xml(), customScrollIFrame\r\n\r\nvar defaultOptions = {\r\n    $mapNavigatorContainer: undefined,\r\n    nameIFrame: \"PP_iframe\",\r\n    pixelsScrollableInSeconds: 2000,\r\n    minWOuterScroll: 23,\r\n    minHOuterScroll: 23,\r\n    minWDraggable: 15,\r\n    minHDraggable: 15,\r\n    minWIFrame: 320,\r\n    minHIFrame: 480,\r\n    responsiveToMovementOfTheCursorInAConfinedSpace: false,\r\n    \r\n    gorizontalFixation: \"center\",\r\n    verticalFixation: \"top\"\r\n};\r\n\r\nvar pageManagerVisualizator = function($container, sessionModel, options) {\r\n    this._options = options;\r\n    var ____ = this;\r\n    ____.$container = $container;\r\n    \r\n    var customScrollIFrame = new modules.customScrollIFrame($container, this._options);\r\n    var mapNavigatorIFrame = new modules.mapNavigatorIFrame(options.$mapNavigatorContainer, this._options);\r\n    var resizeIFrame = new modules.resizeIFrame($container, this._options);\r\n    var fixationContentAtResize = new modules.fixationContentAtResize($container, this._options);\r\n    \r\n    //Синхронизируем с кастомным скроллом\r\n    customScrollIFrame._initPasteHTML();\r\n    $container.on(\"pmv.load.iframe\", function(){\r\n        customScrollIFrame.reload();\r\n    });\r\n    //Синхронизируем с мап навигатором\r\n    $container.on(\"pmv.load.iframe\", mapNavigatorIFrame.reload);\r\n    //Синхронизируем с ресайзером\r\n    $container.on(\"pmv.load.iframe\", resizeIFrame.reload);\r\n    //Синхронизируем с фиксатором контента при ресайзе\r\n    $container.on({\r\n        \"pmv.load.iframe\": fixationContentAtResize.reload,\r\n        \"rif.start.resize\": fixationContentAtResize.startFixation,\r\n        \"rif.stop.resize\": fixationContentAtResize.stopFixation\r\n    });\r\n    \r\n    this._create = function() {\r\n        this._init();\r\n        \r\n        //Чтобы скролл работал не только в iFrame Но и во всём блоке\r\n        $container.on('wheel', customScrollIFrame._handlerMouseWheel);\r\n    }\r\n    \r\n    this._destroy = function() {\r\n        //Чтобы скролл работал не только в iFrame Но и во всём блоке\r\n        $container.off('wheel', customScrollIFrame._handlerMouseWheel);\r\n        ____._saveSession();\r\n        \r\n        $container.find( \".pmv-outer-wrap\" ).remove();\r\n    }\r\n    \r\n    this._init = function() {\r\n        $container.append('<div class=\"pmv-outer-wrap\"><div class=\"pmv-fitting-wrap\"></div></div>');\r\n        $container.append('<div class=\"pmv-container-bl\"></div><div class=\"pmv-container-bb\"></div><div class=\"pmv-container-br\"></div>');\r\n        //Получем список страниц\r\n        options.pageList = {};\r\n        ____._restoreSession( \"pagelist\" );\r\n        $container.on(\"pmv.load.iframe\", function(){\r\n            ____._restoreSession( \"size_iframe\" );\r\n            ____._restoreSession( \"scroll_iframe\" );\r\n            ____._restoreSession( \"position_iframe\" );\r\n            \r\n            resizeIFrame._centerIFrameAndNoEmptySpace();//И так сработает после всех методов - потому что события выполняються позже (КРОМЕ FIREFOX)\r\n        });\r\n    }\r\n    \r\n    this.selectPage = function(href) {\r\n        ____.currentPage = href;\r\n        ____._destroyIFrame();\r\n        ____._createIFrame(href);\r\n    }\r\n    \r\n    this._createIFrame = function(href) {\r\n        $container.trigger(\"pmv.prepaste.iframe\");\r\n        ____.lastLoadPage = href;\r\n        ____.currentPage = href;\r\n        $container.find( \".pmv-fitting-wrap\" ).append('<iframe id=\"'+(____._options.nameIFrame)+'\" name=\"'+(____._options.nameIFrame)+'\" src=\"'+href+'\" width=\"100%\" height=\"100%\"></iframe>');\r\n        $('#'+(____._options.nameIFrame)).load(function(){\r\n            $container.trigger( \"pmv.load.iframe\");\r\n            $('#'+(____._options.nameIFrame)).contents().find('body').on('click', function(e){\r\n                $(\"body\").trigger( \"click.body.iframe\" );\r\n            });\r\n        });\r\n    }\r\n    \r\n    this._destroyIFrame = function() {\r\n        ____._saveSession();        \r\n        $( '#'+(____._options.nameIFrame) ).remove();\r\n    }\r\n    \r\n    this._restoreSession = function( specific ) {\r\n        if( !(\"$session\" in ____) ) {\r\n            ____.$session.find( \"pages page\" ).each(function(){\r\n                ____._options.pageList[$(this).attr(\"href\")] = {\r\n                    active: ($(this).attr(\"active\") == \"true\") ? true : false\r\n                }\r\n            });\r\n        }\r\n        \r\n        switch( specific ) {\r\n            //Загрузка активной страницы \r\n            case \"pagelist\":\r\n                for(var key in ____._options.pageList) {\r\n                    if(____._options.pageList[key].active) {\r\n                        ____.selectPage(key);\r\n                        break;\r\n                    }\r\n                } \r\n                break;\r\n            case \"scroll_iframe\":\r\n                var iframe = window[____._options.nameIFrame];\r\n                var scrollTop, scrollLeft;\r\n                \r\n                var $page = ____.$session.find( \" page[href='\"+____.lastLoadPage+\"'][scrolltop][scrollleft]\" );\r\n                if( $page.size() && ____.lastLoadPage in ____._options.pageList ) {\r\n                    scrollTop = parseInt( $page.attr( \"scrolltop\" ) );\r\n                    scrollLeft = parseInt( $page.attr( \"scrollleft\" ) );\r\n                    \r\n                    $(iframe.window).scrollTop( scrollTop );\r\n                    $(iframe.window).scrollLeft( scrollLeft );\r\n                }\r\n                break;\r\n            case \"position_iframe\": \r\n                var iframe = window[____._options.nameIFrame];\r\n                var $iframe = $(\"#\"+(____._options.nameIFrame));\r\n                var $fittingWrap = $iframe.closest(\".pmv-fitting-wrap\");\r\n                var t, l;\r\n                \r\n                var $page = ____.$session.find( \" page[href='\"+____.lastLoadPage+\"'][l][t]\" );\r\n                if( $page.size() && ____.lastLoadPage in ____._options.pageList ) {\r\n                    l = parseInt( $page.attr( \"l\" ) );\r\n                    t = parseInt( $page.attr( \"t\" ) );\r\n                    \r\n                    $fittingWrap.css({\r\n                        left: l,\r\n                        top: t\r\n                    });\r\n                }\r\n                break;\r\n            case \"size_iframe\":\r\n                var iframe = window[____._options.nameIFrame];\r\n                var $iframe = $(\"#\"+(____._options.nameIFrame));\r\n                var $fittingWrap = $iframe.closest(\".pmv-fitting-wrap\");\r\n                var w, h;\r\n                \r\n                var $page = ____.$session.find( \" page[href='\"+____.lastLoadPage+\"'][w][h]\" );\r\n                if( $page.size() ) {\r\n                    w = parseInt( $page.attr( \"w\" ) );\r\n                    h = parseInt( $page.attr( \"h\" ) );\r\n                    \r\n                    $fittingWrap.css({\r\n                        width: w,\r\n                        height: h\r\n                    });\r\n                }\r\n                break;\r\n        }\r\n    }\r\n    \r\n    this._saveSession = function() {\r\n        if( \"$session\" in ____ ) {\r\n            //Сохраняем страницы (синхронизируем pageList и xml)\r\n                var $pages = ____.$session.find( \" pages\" );\r\n                var pre_href;\r\n                //вставляем которых нет в xml\r\n                for(var href in ____._options.pageList) {\r\n                    var page = ____._options.pageList[href];\r\n                    \r\n                    var $page = $pages.find( \"page[href='\"+(href)+\"']\" );\r\n                    if( $page.size() ) {\r\n                        $page.attr( \"active\", page.active );\r\n                    } else {\r\n                        if( pre_href ) {\r\n                            var $page = $pages.find( \"page[href='\"+(pre_href)+\"']\" );\r\n                            $page.after( '<page href=\"'+(href)+'\" active=\"'+(page.active)+'\" />' );\r\n                        } else {\r\n                            $pages.append( '<page href=\"'+(href)+'\" active=\"'+(page.active)+'\" />' );\r\n                        }\r\n                    }\r\n                    pre_href = href;\r\n                }\r\n                //удаляем которых нет в pageList\r\n                $pages.find( \" page\" ).each(function(){\r\n                    if( !($(this).attr( \"href\" ) in ____._options.pageList) ) {\r\n                        $(this).remove();\r\n                    }\r\n                });\r\n            \r\n            //Сохраняем состояние iFrame (если он есть)\r\n            if( ____._options.nameIFrame in window ) {\r\n                var $thisPage = ____.$session.find( \"pages page[href='\"+(____.lastLoadPage)+\"']\" );\r\n                if( $thisPage.size() ) {\r\n                    var iframe = window[____._options.nameIFrame];\r\n                    var $iframe = $(\"#\"+(____._options.nameIFrame));\r\n                    var $fittingWrap = $iframe.closest(\".pmv-fitting-wrap\");\r\n                    \r\n                    $thisPage\r\n                        .attr( \"scrolltop\", Math.round( $(iframe.window).scrollTop() || 0) )\r\n                        .attr( \"scrollleft\",  Math.round( $(iframe.window).scrollLeft() || 0) )\r\n                        .attr( \"l\", Math.round( $fittingWrap.position().left) )\r\n                        .attr( \"t\", Math.round( $fittingWrap.position().top) )\r\n                        .attr( \"w\", Math.round( $fittingWrap.width()) )\r\n                        .attr( \"h\", Math.round( $fittingWrap.height()) );\r\n                }\r\n            }\r\n            \r\n            //'<\\?xml version=\"1.0\" encoding=\"UTF-8\"\\?>'+\r\n            var resxml = ____.$session.xml().join('');\r\n            \r\n            //Записываем в файл\r\n            $.ajax({\r\n                url: \"sb.php\",\r\n                async: true,\r\n                cache: false,\r\n                type: \"POST\",\r\n                data: ({module: 'setfile', dir: ____._options.urlXML, file_text: resxml, text_encoding: 'UTF-8'})\r\n            });\r\n        }\r\n    }\r\n    \r\n    this._restoreSessionFromSubModules = function() {\r\n        resizeIFrame._restoreSession();\r\n        customScrollIFrame._restoreSession();\r\n        mapNavigatorIFrame._restoreSession();\r\n        \r\n        resizeIFrame._centerIFrameAndNoEmptySpace();//И так сработает после всех методов - потому что события выполняються позже (КРОМЕ FIREFOX)\r\n    }          \r\n}\r\n    \r\n/*jQuery.fn.responsiveBlock = function(options){\r\n    options = $.extend({\r\n        defColor:\"white\",\r\n        hoverColor:\"red\"\r\n    }, options});\r\n\r\n    var make = function(){\r\n        \r\n    };\r\n\r\n    return this.each(make);*/\r\n    modules.pageManagerVisualizator = pageManagerVisualizator;\r\n    \r\n})(jQuery);"]}